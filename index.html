<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グリーンバック撮影</title>
    <style>
        body { font-family: sans-serif; display: grid; place-items: center; min-height: 90vh; background: #f0f0f0; }
        .container { max-width: 800px; margin: 1rem; }
        #camera-view, #qr-view { text-align: center; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 5px; background: #333; }
        button { font-size: 1.2rem; padding: 0.8rem 1.5rem; margin-top: 1rem; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #capture-btn { background-color: #d9534f; }
        #capture-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        #reset-btn { background-color: #5bc0de; }
        #qr-container img { max-width: 90%; }
        #loading { font-size: 1.5rem; color: #555; display: none; }
        canvas { display: none; }
        #bg-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .bg-thumbnail {
            width: 100px;
            height: 70px;
            object-fit: cover;
            border: 3px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bg-thumbnail:hover { transform: scale(1.05); }
        .bg-thumbnail.selected {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.5);
        }
        .bg-item { position: relative; }
        .bg-item::after {
            content: '▶'; /* 動画アイコン */
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-shadow: 0 0 5px black;
            opacity: 0.7;
            display: none; /* JSで動画の場合だけ表示 */
        }
        .bg-item.video::after { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div id="camera-view">
            <h1>1. 背景を選んでください</h1>
            <div id="bg-selector">
                {% if backgrounds %}
                    {% for bg in backgrounds %}
                        <div class="bg-item {% if bg.endswith('.mp4') or bg.endswith('.mov') %}video{% endif %}" 
                             data-filename="{{ bg }}">
                            <img src="/background/{{ bg }}" alt="{{ bg }}" class="bg-thumbnail">
                        </div>
                    {% endfor %}
                {% else %}
                    <p>backgrounds フォルダに背景ファイルがありません。</p>
                    <p>（app.py と同じ階層に 'backgrounds' フォルダを作ってください）</p>
                {% endif %}
            </div>

            <h1>2. グリーンバックの前に立つ</h1>
            <video id="video" autoplay playsinline></video>
            
            <button id="capture-btn" disabled>📸 撮影する (まず背景を選んでね)</button>
            <p id="loading">合成中... (動画は10秒ほどかかります)</p>
            <canvas id="canvas"></canvas> </div>

        <div id="qr-view" style="display: none;">
            <h1>QRコードを読み取ってください</h1>
            <p>読み込んだら「次へ」を押してください</p>
            <div id="qr-container"></div>
            <button id="reset-btn">次の人へ</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const resetBtn = document.getElementById('reset-btn');
        const cameraView = document.getElementById('camera-view');
        const qrView = document.getElementById('qr-view');
        const qrContainer = document.getElementById('qr-container');
        const loading = document.getElementById('loading');
        const bgSelector = document.getElementById('bg-selector');
        let selectedBackground = null;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("カメラエラー: ", err);
                alert("カメラを起動できませんでした。");
            }
        }

        bgSelector.addEventListener('click', (e) => {
            const item = e.target.closest('.bg-item');
            if (!item) return;
            document.querySelectorAll('.bg-thumbnail').forEach(thumb => {
                thumb.classList.remove('selected');
            });
            item.querySelector('.bg-thumbnail').classList.add('selected');
            selectedBackground = item.dataset.filename;
            captureBtn.disabled = false;
            captureBtn.textContent = '📸 撮影する';
        });

        captureBtn.addEventListener('click', async () => {
            if (!selectedBackground) {
                alert('背景を選択してください！');
                return;
            }
            loading.style.display = 'block';
            captureBtn.style.display = 'none';
            bgSelector.style.display = 'none';
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: imageDataUrl,
                        background: selectedBackground
                    })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'サーバーでエラーが発生しました');
                }
                const result = await response.json();
                qrContainer.innerHTML = `<img src="${result.qr_code}" alt="写真QRコード">`;
                cameraView.style.display = 'none';
                qrView.style.display = 'block';
            } catch (err) {
                console.error('送信エラー:', err);
                alert(`エラー: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                captureBtn.style.display = 'block';
                bgSelector.style.display = 'flex';
            }
        });

        resetBtn.addEventListener('click', () => {
            qrView.style.display = 'none';
            cameraView.style.display = 'block';
            qrContainer.innerHTML = '';
            document.querySelectorAll('.bg-thumbnail').forEach(thumb => {
                thumb.classList.remove('selected');
            });
            selectedBackground = null;
            captureBtn.disabled = true;
            captureBtn.textContent = '📸 撮影する (まず背景を選んでね)';
        });

        startCamera();
    </script>
</body>
</html>