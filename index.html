<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚°ãƒªãƒ¼ãƒ³ãƒãƒƒã‚¯æ’®å½±</title>
    <style>
        body { font-family: sans-serif; display: grid; place-items: center; min-height: 90vh; background: #f0f0f0; }
        .container { max-width: 800px; margin: 1rem; }
        #camera-view, #qr-view { text-align: center; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 5px; background: #333; }
        button { font-size: 1.2rem; padding: 0.8rem 1.5rem; margin-top: 1rem; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #capture-btn { background-color: #d9534f; }
        #capture-btn:disabled { background-color: #aaa; cursor: not-allowed; }
        #reset-btn { background-color: #5bc0de; }
        #qr-container img { max-width: 90%; }
        #loading { font-size: 1.5rem; color: #555; display: none; }
        canvas { display: none; }
        #bg-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .bg-thumbnail {
            width: 100px;
            height: 70px;
            object-fit: cover;
            border: 3px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bg-thumbnail:hover { transform: scale(1.05); }
        .bg-thumbnail.selected {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.5);
        }
        .bg-item { position: relative; }
        .bg-item::after {
            content: 'â–¶'; /* å‹•ç”»ã‚¢ã‚¤ã‚³ãƒ³ */
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-shadow: 0 0 5px black;
            opacity: 0.7;
            display: none; /* JSã§å‹•ç”»ã®å ´åˆã ã‘è¡¨ç¤º */
        }
        .bg-item.video::after { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div id="camera-view">
            <h1>1. èƒŒæ™¯ã‚’é¸ã‚“ã§ãã ã•ã„</h1>
            <div id="bg-selector">
                {% if backgrounds %}
                    {% for bg in backgrounds %}
                        <div class="bg-item {% if bg.endswith('.mp4') or bg.endswith('.mov') %}video{% endif %}" 
                             data-filename="{{ bg }}">
                            <img src="/background/{{ bg }}" alt="{{ bg }}" class="bg-thumbnail">
                        </div>
                    {% endfor %}
                {% else %}
                    <p>backgrounds ãƒ•ã‚©ãƒ«ãƒ€ã«èƒŒæ™¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <p>ï¼ˆapp.py ã¨åŒã˜éšå±¤ã« 'backgrounds' ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã£ã¦ãã ã•ã„ï¼‰</p>
                {% endif %}
            </div>

            <h1>2. ã‚°ãƒªãƒ¼ãƒ³ãƒãƒƒã‚¯ã®å‰ã«ç«‹ã¤</h1>
            <video id="video" autoplay playsinline></video>
            
            <button id="capture-btn" disabled>ğŸ“¸ æ’®å½±ã™ã‚‹ (ã¾ãšèƒŒæ™¯ã‚’é¸ã‚“ã§ã­)</button>
            <p id="loading">åˆæˆä¸­... (å‹•ç”»ã¯10ç§’ã»ã©ã‹ã‹ã‚Šã¾ã™)</p>
            <canvas id="canvas"></canvas> </div>

        <div id="qr-view" style="display: none;">
            <h1>QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</h1>
            <p>èª­ã¿è¾¼ã‚“ã ã‚‰ã€Œæ¬¡ã¸ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
            <div id="qr-container"></div>
            <button id="reset-btn">æ¬¡ã®äººã¸</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const resetBtn = document.getElementById('reset-btn');
        const cameraView = document.getElementById('camera-view');
        const qrView = document.getElementById('qr-view');
        const qrContainer = document.getElementById('qr-container');
        const loading = document.getElementById('loading');
        const bgSelector = document.getElementById('bg-selector');
        let selectedBackground = null;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ", err);
                alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        }

        bgSelector.addEventListener('click', (e) => {
            const item = e.target.closest('.bg-item');
            if (!item) return;
            document.querySelectorAll('.bg-thumbnail').forEach(thumb => {
                thumb.classList.remove('selected');
            });
            item.querySelector('.bg-thumbnail').classList.add('selected');
            selectedBackground = item.dataset.filename;
            captureBtn.disabled = false;
            captureBtn.textContent = 'ğŸ“¸ æ’®å½±ã™ã‚‹';
        });

        captureBtn.addEventListener('click', async () => {
            if (!selectedBackground) {
                alert('èƒŒæ™¯ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼');
                return;
            }
            loading.style.display = 'block';
            captureBtn.style.display = 'none';
            bgSelector.style.display = 'none';
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: imageDataUrl,
                        background: selectedBackground
                    })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
                const result = await response.json();
                qrContainer.innerHTML = `<img src="${result.qr_code}" alt="å†™çœŸQRã‚³ãƒ¼ãƒ‰">`;
                cameraView.style.display = 'none';
                qrView.style.display = 'block';
            } catch (err) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
                alert(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
            } finally {
                loading.style.display = 'none';
                captureBtn.style.display = 'block';
                bgSelector.style.display = 'flex';
            }
        });

        resetBtn.addEventListener('click', () => {
            qrView.style.display = 'none';
            cameraView.style.display = 'block';
            qrContainer.innerHTML = '';
            document.querySelectorAll('.bg-thumbnail').forEach(thumb => {
                thumb.classList.remove('selected');
            });
            selectedBackground = null;
            captureBtn.disabled = true;
            captureBtn.textContent = 'ğŸ“¸ æ’®å½±ã™ã‚‹ (ã¾ãšèƒŒæ™¯ã‚’é¸ã‚“ã§ã­)';
        });

        startCamera();
    </script>
</body>
</html>